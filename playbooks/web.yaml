- name: Lab Company Profile Website
  hosts: web
  remote_user: mrz
  vars:
    git:
      owner: Lab-ICN
      repo: web-icn-fe
      branch: main
      username: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31373034616166306439666438376335616433306135616233353365646165303430666462376331
          3639393839383661383164383336663262626335393637330a316434306234646133316564666133
          31616132633263373634313762353433386330396234633265313365356461346139643239343565
          6161363633313462310a643130336234663461313830343661653735313539313231353936313332
          3465
      pat: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37353230653734396661326338663232373533343731336438386163316130353063366466663938
          3434313835616165333032616262336439616330656538330a383636373334376136323637613939
          61303063373566623563323839303066373731623730313565623162333933656437383334653033
          3266616263633666660a386633313461666139666234393534316266363031636265336462303233
          34333566363133663535343136633463303663626662323338323533396238366534333937373134
          3964396337333635383630643364383635333939343334613965

    home: /home/mrz
  tasks:
    - name: Clone web remote repository
      ansible.builtin.git:
        repo: "https://{{ git.username }}:{{ git.pat }}@github.com/{{ git.owner }}/{{ git.repo }}.git"
        dest: "$HOME/{{ git.repo }}"
        version: "{{ git.branch }}"
        single_branch: true
        depth: 1

    - name: Build Docker image from Dockerfile
      become: true
      community.docker.docker_image:
        # FIXME: DONT use latest for tag
        name: "{{ git.repo }}:latest"
        source: build
        force_source: true
        build:
          path: "{{ home }}/{{ git.repo }}"
          pull: true
          nocache: false

    - name: Create and run Docker container
      become: true
      community.docker.docker_container:
        name: "{{ git.repo }}"
        image: "{{ git.repo }}:latest"
        ports: ["3000:3000"]
        restart_policy: always
